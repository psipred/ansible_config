---
#
# This roles assumes the ogs build worker AND it left behind the tarballs and
# the compiled stuff in /opt/ogs_src/GE2011.11 and /opt/sge6_dist
#

#export SGE_ROOT=/opt/ogs_src/GE2011.11/
  - name: Install expect
    yum:
      pkg: expect
      state: latest
    sudo: yes

#open ports 6444 and 6445

  - name: Get the current firewalld rules
    shell: firewall-cmd --list-all
    register: firewalldrules
    always_run: yes
    sudo: yes

  - name: Add Postgres firewalld rules
    command: firewall-cmd --zone=public --add-port=6444/tcp --permanent
    sudo: yes
    when: firewalldrules.stdout.find("6444"/tcp") == -1

  - name: Add Postgres firewalld rules
    command: firewall-cmd --zone=public --add-port=6445/tcp --permanent
    sudo: yes
    when: firewalldrules.stdout.find("6445"/tcp") == -1

  - name: Reload firewalld
    command: firewall-cmd --reload
    sudo: true

  - name: add ogs_admin group
    group: name=ogs state=present

  - name: "Add {{ ogs_admin_user }}"
    user: "name={{ ogs_admin_user }} password={{ ogs_admin_hashed_password }} group=ogs"
    sudo: yes

  - name: give {{ ogs_admin_user }} permissions on the ogs_src
    sudo: yes
    file:
       path: /opt/ogs_src
       group: ogs
       recurse: yes
       mode: "g+rw"
       state: directory

  - name: Move qmaster expect script
    become_user: root
    copy:
      src: files/ogs_setup.exp
      dest: /opt/ogs_src/GE2011.11

  - name: Check if we have default cluster config present
    stat: "path=/opt/ogs_src/GE2011.11/default/"
    become_user: root
    register: default_present

  - name: Run install_qmaster expect script
    become_user: root
    shell: "cd /opt/ogs_src/GE2011.11/; /opt/ogs_src/GE2011.11/ogs_setup.exp"
    when: default_present == -1

  - name: Move execd expect script
    become_user: root
    copy:
      src: files/execd_setup.exp
      dest: /opt/ogs_src/GE2011.11

  - name: Run install_exced expect script
    become_user: root
    shell: "cd /opt/ogs_src/GE2011.11/; /opt/ogs_src/GE2011.11/execd_setup.exp"
    when: default_present == -1

  - name: move default config dir to exec hosts
    become_user: root
    synchronize:
      mode: pull
      src: /opt/ogs_src/GE2011.11/default
      dest: /tmp/
    delegate_to: bioinfstage3 #128.16.14.83
    when: default_present == -1

  - name: move sge-common
    become_user: root
    synchronize:
      mode: pull
      src: /opt/sge6_dist/ge-GE2011.11-common.tar.gz
      dest: /tmp/
    delegate_to: bioinfstage3 #128.16.14.83
    when: default_present == -1

  - name: move sge-linux binaries
    become_user: root
    synchronize:
      mode: pull
      src: /opt/sge6_dist/ge-GE2011.11-bin-linux-x64.tar.gz
      dest: /tmp/
    delegate_to: bioinfstage3 #128.16.14.83
    when: default_present == -1

  # - name: restart qmaster
  #   shell: service sgeexecd.p6444 stop && sgeexecd.p6444 start
  #   when: default_present == 1

  # - name: restart execd
  #   shell: service sgemaster.p6444 stop && sgemaster.p6444 start
  #   when: default_present == 1
