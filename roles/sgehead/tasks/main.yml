---
#
# This roles assumes the ogs build worker AND it left behind the tarballs and
# the compiled stuff in /opt/ogs_src/GE2011.11 and /opt/sge6_dist
#

#export SGE_ROOT=/opt/ogs_src/GE2011.11/
  - name: Install expect
    yum:
      pkg: expect
      state: latest
    become_user: root
    become_method: sudo

#open ports 6444 and 6445

  - name: Get the current firewalld rules
    shell: firewall-cmd --list-all
    register: firewalldrules
    always_run: yes
    become_user: root
    become_method: sudo

  - name: Add Postgres firewalld rules
    command: firewall-cmd --zone=public --add-port=6444/tcp --permanent
    become_user: root
    become_method: sudo
    when: firewalldrules.stdout.find("6444/tcp") == -1

  - name: Add Postgres firewalld rules
    command: firewall-cmd --zone=public --add-port=6445/tcp --permanent
    become_user: root
    become_method: sudo
    when: firewalldrules.stdout.find("6445/tcp") == -1

  - name: Reload firewalld
    command: firewall-cmd --reload
    become_user: root
    become_method: sudo

  - name: add ogs_admin group
    group: name=ogs state=present

  - name: "Add {{ ogs_admin_user }}"
    user: "name={{ ogs_admin_user }} password={{ ogs_admin_hashed_password }} group=ogs"
    become_user: root
    become_method: sudo

  - name: give {{ ogs_admin_user }} permissions on the ogs_src
    become_user: root
    become_method: sudo
    file:
       path: /opt/ogs_src
       group: ogs
       recurse: yes
       mode: "g+rw"
       state: directory

  - name: Move qmaster expect script
    become_user: root
    copy:
      src: files/ogs_setup.exp
      dest: /opt/ogs_src/GE2011.11

  - name: give {{ ogs_admin_user }} permissions on ogs_setup.exp
    become_user: root
    become_method: sudo
    file:
       path: /opt/ogs_src/GE2011.11/ogs_setup.exp
       group: ogs
       mode: "uog+x"

  - name: Check if we have default cluster config present
    stat: "path=/opt/ogs_src/GE2011.11/default/"
    become_user: root
    register: default_present

  - name: Run install_qmaster expect script
    become_user: root
    shell: "cd /opt/ogs_src/GE2011.11/; /opt/ogs_src/GE2011.11/ogs_setup.exp"
    when: default_present.stat.isdir is not defined
    environment:
      SGE_HOME: /opt/ogs_src/GE2011.11

  - name: Move execd expect script
    become_user: root
    copy:
      src: files/execd_setup.exp
      dest: /opt/ogs_src/GE2011.11

  - name: "Move bash profile for {{ ogs_admin_user }}"
    copy:
      src: files/ogs_admin_bash_profile
      dest: "/home/{{ ogs_admin_user }}/.bash_profile"

  - name: "give {{ ogs_admin_user }} permissions on bash_profile"
    become_user: root
    become_method: sudo
    file:
       path: "/home/{{ ogs_admin_user }}/.bash_profile"
       group: 16485
       mode: "g+rw"
       owner: "{{ ogs_admin_user }}"

  - name: "give {{ ogs_admin_user }} permissions on execd_setup.exp"
    become_user: root
    become_method: sudo
    file:
       path: /opt/ogs_src/GE2011.11/execd_setup.exp
       group: ogs
       mode: "uog+x"

  - name: Run install_exced expect script
    become_user: root
    shell: "cd /opt/ogs_src/GE2011.11/; /opt/ogs_src/GE2011.11/execd_setup.exp"
    when: default_present.stat.isdir is not defined
    environment:
      SGE_HOME: /opt/ogs_src/GE2011.11

  - name: Add head node as submit host
    shell: "/opt/ogs_src/GE2011.11/bin/linux-x64/qconf -as bioinfstage3"
    become_user: "{{ ogs_admin_user }}"
    when: default_present.stat.isdir is not defined
    environment:
      SGE_ROOT: /opt/ogs_src/GE2011.11

  # Ideally we would remove the host from the queue but this requires multiple
  # interactive editor sessions see
  # https://resbook.wordpress.com/2011/03/21/remove-execution-host-from-gridengine/
  - name: Disable job submissions to the head node
    shell: "/opt/ogs_src/GE2011.11/bin/linux-x64/qmod -d all.q@bioinfstage3"
    become_user: "{{ ogs_admin_user }}"
    when: default_present.stat.isdir is not defined
    environment:
      SGE_ROOT: /opt/ogs_src/GE2011.11

  - name: build default tarball
    shell: "cd /opt/ogs_src/GE2011.11/; tar -pczf default.tar.gz default/"
    become_user: root

  - name: get the default config dir
    fetch:
      src: /opt/ogs_src/GE2011.11/default.tar.gz
      dest: files/
      fail_on_missing: yes
      flat: yes

  - name: get the sge-common
    fetch:
      src: /opt/sge6_dist/ge-GE2011.11-common.tar.gz
      dest: files/
      fail_on_missing: yes
      flat: yes

  - name: get the sge-linux binaries
    fetch:
      src: /opt/sge6_dist/ge-GE2011.11-bin-linux-x64.tar.gz
      dest: files/
      fail_on_missing: yes
      flat: yes

  - name: rewrite the first line of the sgemaster.staging6444
    shell: sed "1s/.*/#\!\/bin\/sh/" /etc/init.d/sgemaster.staging6444 > /tmp/sgemaster.staging6444
    sudo: yes

  - name: rewrite the 2nd line of the sgemaster.staging6444
    shell: sed "2s/.*/sed -e s\/#ENFORCE_SHLIBPATH#\/\/ dist\/util\/rctemplates\/sgemaster_template/" /tmp/sgemaster.staging6444 > /etc/init.d/sgemaster.staging6444
    sudo: yes

  - name: rewrite the first line of the sgeexecd.staging6444
    shell: sed "1s/.*/#\!\/bin\/sh/" /etc/init.d/sgeexecd.staging6444 > /tmp/sgeexecd.staging6444
    sudo: yes

  - name: rewrite the 2nd line of the sgemaster.staging6444
    shell: sed "2s/.*/sed -e s\/#ENFORCE_SHLIBPATH#\/\/ dist\/util\/rctemplates\/sgeexecd_template/" /tmp/sgeexecd.staging6444 > /etc/init.d/sgeexecd.staging6444
    sudo: yes

#if we want to force a reinstall then you need to remove the sge startup
#scripts in /etc/init.d/sge* and delete the /opt/ogs_src/GE2011.11/default dir

  # - name: restart qmaster
  #   shell: service sgemaster.p6444 stop && sgemaster.p6444 start
  #   when: default_present == 1
    # environment:
    #   SGE_ROOT: /opt/ogs_src/GE2011.11

  # - name: restart execd
  #   shell: service sgeexecd.p6444 stop && sgeexecd.p6444 start
  #   when: default_present.stat.isdir == True
  #   environment:
  #     SGE_ROOT: /opt/ogs_src/GE2011.11
